# Production Environment Configuration for ChemAudit
#
# SECURITY WARNING: This file contains sensitive configuration.
# - DO NOT commit this file with real credentials
# - DO NOT use default passwords in production
# - Use strong, randomly generated passwords
# - Consider using environment variable management tools (AWS Secrets Manager, HashiCorp Vault, etc.)
#
# The deploy.sh script will auto-generate secure secrets for any CHANGE_ME values.

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================
POSTGRES_USER=chemaudit
# IMPORTANT: Change this to a strong password in production
POSTGRES_PASSWORD=CHANGE_ME_STRONG_PASSWORD_HERE
POSTGRES_DB=chemaudit
DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}

# =============================================================================
# REDIS CONFIGURATION
# =============================================================================
# REQUIRED: Set a strong Redis password for production
# Redis authentication is enforced — connections without a password will be rejected
REDIS_PASSWORD=CHANGE_ME_REDIS_PASSWORD
REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
REDIS_MAXMEMORY=512mb

# =============================================================================
# SECURITY SECRETS (REQUIRED - Generate secure values!)
# =============================================================================
# The deploy.sh script auto-generates these if they contain CHANGE_ME.
# To generate manually: openssl rand -hex 64
SECRET_KEY=CHANGE_ME_GENERATE_WITH_openssl_rand_hex_64

# Admin secret for API key management endpoints
# Generate with: openssl rand -hex 32
API_KEY_ADMIN_SECRET=CHANGE_ME_ADMIN_SECRET_FOR_KEY_MANAGEMENT

# CSRF protection secret
# Generate with: openssl rand -hex 32
CSRF_SECRET_KEY=CHANGE_ME_CSRF_SECRET_32_CHARS

# =============================================================================
# APPLICATION SETTINGS
# =============================================================================
# IMPORTANT: Set to false in production to enforce secure defaults
# When DEBUG=false, the app rejects startup if secrets still have CHANGE_ME values
DEBUG=false

# Logging level: debug, info, warning, error, critical
LOG_LEVEL=info

# Python settings
PYTHONUNBUFFERED=1
PYTHONDONTWRITEBYTECODE=1

# =============================================================================
# API Key Settings
# =============================================================================
API_KEY_DEFAULT_EXPIRY_DAYS=90
API_KEY_MAX_EXPIRY_DAYS=365

# =============================================================================
# Rate Limiting
# =============================================================================
RATE_LIMIT_ENABLED=true
RATE_LIMIT_BAN_THRESHOLD=100
RATE_LIMIT_BAN_DURATION_MINUTES=60

# =============================================================================
# CORS Configuration
# =============================================================================
# Comma-separated list of allowed origins (update with your domain)
CORS_ORIGINS_STR=https://your-domain.com

# =============================================================================
# API Configuration
# =============================================================================
API_HOST=0.0.0.0
API_PORT=8001

# =============================================================================
# External API Keys
# =============================================================================
COCONUT_API_TOKEN=  # Required for COCONUT natural products database

# =============================================================================
# MONITORING
# =============================================================================
# Enable Prometheus metrics endpoint (restricted to internal IPs)
ENABLE_METRICS=true

# =============================================================================
# CELERY CONFIGURATION
# =============================================================================
# Celery log level: debug, info, warning, error, critical
CELERY_LOG_LEVEL=info

# Number of concurrent workers (adjust based on server resources)
# Recommended: number of CPU cores
CELERY_WORKERS=4                    # Workers for large batch jobs (default queue)
CELERY_WORKERS_PRIORITY=2           # Workers for small/priority jobs (high_priority queue)

# =============================================================================
# Batch Processing Limits
# =============================================================================
MAX_FILE_SIZE_MB=500
MAX_BATCH_SIZE=10000

# =============================================================================
# NGINX CONFIGURATION
# =============================================================================
# HTTP and HTTPS ports
HTTP_PORT=80
HTTPS_PORT=443

# =============================================================================
# GRAFANA CONFIGURATION (if using monitoring profile)
# =============================================================================
GRAFANA_USER=admin
# IMPORTANT: Change this to a strong password in production
GRAFANA_PASSWORD=CHANGE_ME_GRAFANA_PASSWORD
GRAFANA_URL=http://localhost:3001

# =============================================================================
# PRODUCTION SETTINGS (for docker-compose.prod.yml)
# =============================================================================
DEPLOYMENT_PROFILE=medium
GUNICORN_WORKERS=4
BACKEND_MEMORY_LIMIT=2g
CELERY_MEMORY_LIMIT=2g
CELERY_PRIORITY_MEMORY_LIMIT=1g

# =============================================================================
# PRODUCTION DEPLOYMENT NOTES
# =============================================================================
#
# 1. SSL/TLS Setup:
#    - Obtain SSL certificates (Let's Encrypt recommended)
#    - Place certificates in ./nginx/ssl/ directory
#    - Copy nginx/nginx-ssl.conf to nginx/conf.d/ and update paths
#    - Set certificate paths in nginx configuration
#
# 2. Domain Configuration:
#    - Update server_name in nginx/nginx.conf
#    - Configure DNS A records to point to your server
#    - Update GRAFANA_URL and CORS_ORIGINS_STR with your domain
#
# 3. Security Hardening (applied by default):
#    - Redis authentication enforced (REDIS_PASSWORD required)
#    - Secrets validated at startup (DEBUG=false rejects CHANGE_ME values)
#    - CSRF protection enabled for browser sessions
#    - API key hashing in rate limit keys
#    - Batch job ownership enforced via session cookies
#    - Container security: cap_drop ALL, no-new-privileges
#    - /metrics restricted to internal IPs only
#    - Nginx: server_tokens off, CSP, Permissions-Policy headers
#    - OpenAPI docs disabled (DEBUG=false)
#
# 4. Additional Security Steps:
#    - Enable firewall (ufw, iptables)
#    - Restrict access to ports 5432 (PostgreSQL), 6379 (Redis), 9090 (Prometheus)
#    - Only expose ports 80 and 443 to public
#    - Enable HTTPS with nginx/nginx-ssl.conf
#    - Consider IP whitelisting for Grafana
#
# 5. Resource Allocation:
#    - Adjust CELERY_WORKERS based on server CPU cores
#    - Set REDIS_MAXMEMORY based on available RAM
#    - Monitor PostgreSQL connections and adjust max_connections if needed
#    - Use deployment profiles (./deploy.sh large) for easy scaling
#
# 6. Backup Strategy:
#    - Regular PostgreSQL backups (pg_dump)
#    - Volume backups for postgres_data, redis_data
#    - Document restore procedures
#
# 7. Monitoring:
#    - Enable monitoring profile: docker-compose --profile monitoring up -d
#    - Configure Prometheus retention based on disk space
#    - Set up alerting rules in Prometheus
#    - Access Grafana at configured GRAFANA_URL
#
# 8. Deployment Commands:
#    # Automated (recommended):
#    ./deploy.sh medium
#
#    # Manual:
#    cd frontend && npm run build && cd ..
#    cp -r frontend/dist frontend-dist
#    docker-compose -f docker-compose.prod.yml up -d
#
#    # Start with monitoring:
#    docker-compose -f docker-compose.prod.yml --profile monitoring up -d
#
# 9. Health Checks:
#    - Backend API: https://your-domain/api/v1/health
#    - Nginx: https://your-domain/health
#    - Prometheus: http://localhost:9090/-/healthy (internal only)
#
# 10. First-Time Setup:
#     - Run deploy.sh — it auto-generates secrets and creates .env
#     - Database tables are auto-created on first startup
#     - Create API keys if needed
#     - Configure Grafana dashboards
