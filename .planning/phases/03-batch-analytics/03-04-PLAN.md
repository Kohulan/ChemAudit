---
phase: 03-batch-analytics
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/pyproject.toml
  - backend/app/services/analytics/chemical_space.py
  - backend/tests/test_analytics_chemspace.py
autonomous: true
requirements:
  - BATCH-09
  - BATCH-10
  - BATCH-11
  - BATCH-12

must_haves:
  truths:
    - "PCA 2D coordinates are computed via randomized numpy SVD, not full SVD or sklearn"
    - "t-SNE coordinates are computed via openTSNE for batches of 2000 or fewer molecules; batches above 2000 are refused with a descriptive error"
    - "Similarity search returns top-k nearest neighbors by Tanimoto for both batch-molecule and external SMILES queries"
    - "Nearest neighbor analysis returns isolation score (1 - max_neighbor_similarity) per molecule"
    - "Similarity matrix returns dense upper-triangle for batches up to 500, sparse representation (sim > threshold) for 500-2000, and refuses batches above 2000"
    - "Morgan fingerprints use rdFingerprintGenerator.GetMorganGenerator (non-deprecated API)"
  artifacts:
    - path: "backend/pyproject.toml"
      provides: "openTSNE dependency"
      contains: "openTSNE"
    - path: "backend/app/services/analytics/chemical_space.py"
      provides: "PCA, t-SNE, similarity search, nearest neighbor, similarity matrix"
      exports: ["compute_pca", "compute_tsne", "find_similar_molecules", "compute_nearest_neighbors", "compute_similarity_matrix"]
    - path: "backend/tests/test_analytics_chemspace.py"
      provides: "Tests for chemical space and similarity operations"
      min_lines: 80
  key_links:
    - from: "backend/app/services/batch/analytics_tasks.py"
      to: "backend/app/services/analytics/chemical_space.py"
      via: "import in run_expensive_analytics chemical_space branch"
      pattern: "from app\\.services\\.analytics\\.chemical_space import"
---

<objective>
Implement chemical space analysis: PCA and t-SNE dimensionality reduction, similarity search, nearest neighbor analysis, and pairwise similarity matrix.

Purpose: Chemical space visualization is a user-triggered expensive analytics type. It lets users explore batch diversity via 2D projections, find similar molecules, and assess chemical space coverage.

Output: `chemical_space.py` service with PCA, t-SNE, similarity, and matrix operations. openTSNE added to dependencies.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-batch-analytics/03-RESEARCH.md
@.planning/phases/03-batch-analytics/03-01-SUMMARY.md

@backend/app/schemas/analytics.py
@backend/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add openTSNE Dependency and Chemical Space Service</name>
  <files>
    backend/pyproject.toml
    backend/app/services/analytics/chemical_space.py
  </files>
  <action>
1. In `backend/pyproject.toml`, add `"openTSNE>=1.0.0"` to the `[project].dependencies` list.

2. Create `backend/app/services/analytics/chemical_space.py`:

**Shared fingerprint utility** (module-level):
```python
from rdkit.Chem import rdFingerprintGenerator
_morgan_gen = rdFingerprintGenerator.GetMorganGenerator(radius=2, fpSize=2048)
```

**_parse_and_fingerprint(results: list[dict]) -> tuple[list[int], list]**:
- For each successful result, parse SMILES, generate Morgan fingerprint.
- Return (molecule_indices, fingerprints) — parallel lists.
- Skip results with status != "success" or unparseable SMILES.

**_fps_to_matrix(fps: list) -> np.ndarray**:
- Convert list of RDKit fingerprints to numpy float32 matrix (n x 2048).
- Use `DataStructs.ConvertToNumpyArray(fp, row)` for each fingerprint.

**compute_pca(results: list[dict], n_components: int = 2) -> dict**:
- Call `_parse_and_fingerprint`.
- If fewer than 3 molecules, return error dict.
- Implement randomized SVD PCA (per research Pattern 7):
  - Center data: `X_centered = X - X.mean(axis=0)`
  - Random projection: `omega = rng.standard_normal((2048, n_components + 10))` with `rng = np.random.default_rng(42)` for reproducibility.
  - QR decomposition: `Q, _ = np.linalg.qr(X_centered @ omega)`
  - Project and SVD: `B = Q.T @ X_centered`, `U, s, Vt = np.linalg.svd(B, full_matrices=False)`
  - Coordinates: `coords = (Q @ U[:, :n_components]) * s[:n_components]`
  - Variance explained: `s[:n_components]**2 / sum(s**2)` as list of floats.
- Return dict matching `ChemSpaceCoordinates` schema with method="pca".

**compute_tsne(results: list[dict], perplexity: int = 30) -> dict**:
- Call `_parse_and_fingerprint`.
- Enforce ≤2000 molecules (per locked decision). If more, return `{"error": "t-SNE limited to 2000 molecules", "molecule_count": len(indices)}`.
- Auto-adjust perplexity: `perplexity = min(perplexity, max(5, len(indices) // 3))` (per research Pitfall 6).
- Import `from openTSNE import TSNE`.
- `tsne = TSNE(n_components=2, perplexity=perplexity, random_state=42, n_jobs=-1)`.
- `coords = tsne.fit(X)` where X is the float32 matrix.
- Return dict matching `ChemSpaceCoordinates` with method="tsne", variance_explained=None.

**find_similar_molecules(results: list[dict], query_smiles: str = None, query_index: int = None, top_k: int = 10) -> dict**:
- Parse and fingerprint all molecules.
- If `query_smiles` provided: parse and fingerprint the query molecule. If `query_index` provided: use that molecule's fingerprint from the batch.
- Compute `DataStructs.BulkTanimotoSimilarity(query_fp, batch_fps)`.
- Sort by similarity descending, take top_k (exclude query itself if it's from the batch).
- Return dict matching `SimilarityResult` schema.

**compute_nearest_neighbors(results: list[dict]) -> list[dict]**:
- Parse and fingerprint all molecules.
- For each molecule: compute BulkTanimotoSimilarity against all others, find max similarity (excluding self).
- `isolation_score = 1.0 - max_neighbor_similarity`.
- Return list of dicts matching `NearestNeighborResult` schema.

**compute_similarity_matrix(results: list[dict], threshold: float = 0.7) -> dict**:
- Parse and fingerprint all molecules.
- If >2000 molecules: return `{"error": "Similarity matrix limited to 2000 molecules"}`.
- If ≤500: compute full dense upper-triangle. `representation="dense"`, `data=[[sim_values for j>i]]`.
- If 500-2000: compute sparse representation. `representation="sparse"`, `data=[{"i": i, "j": j, "similarity": sim} for sim > threshold]`.
- Return dict matching `SimilarityMatrixResult` schema.

Use `float32` throughout for memory efficiency. Include logging for timing of expensive operations.
  </action>
  <verify>
    <automated>cd /Volumes/Data_Drive/Project/2026/chemstructval/backend && /Users/kohulanrajan/anaconda3/envs/cheminformatics/bin/python -c "from app.services.analytics.chemical_space import compute_pca, compute_tsne, find_similar_molecules, compute_nearest_neighbors, compute_similarity_matrix; print('Import OK')"</automated>
  </verify>
  <done>Chemical space service implements PCA (randomized SVD), t-SNE (openTSNE with perplexity guard), similarity search, nearest neighbors, and similarity matrix with size-based representation switching</done>
</task>

<task type="auto">
  <name>Task 2: Chemical Space Tests</name>
  <files>backend/tests/test_analytics_chemspace.py</files>
  <action>
Create `backend/tests/test_analytics_chemspace.py`:

1. **test_pca_returns_2d_coordinates**: Batch of 10 diverse molecules → returns coordinates with shape (10, 2), method="pca", variance_explained is a list of 2 floats summing to ≤1.0.

2. **test_pca_too_few_molecules**: Batch of 2 molecules → returns error dict.

3. **test_pca_reproducible**: Same batch run twice → identical coordinates (seeded RNG).

4. **test_tsne_returns_coordinates**: Batch of 20 molecules → returns 2D coordinates, method="tsne".

5. **test_tsne_refuses_large_batch**: Batch of 2001 molecules (use helper to generate) → returns error dict with "limited to 2000".

6. **test_tsne_auto_adjusts_perplexity**: Batch of 30 molecules with perplexity=30 → should auto-adjust to ≤10 and succeed (not crash).

7. **test_find_similar_by_smiles**: Query SMILES against batch → returns top_k neighbors sorted by descending similarity, all similarity values are 0-1 floats.

8. **test_find_similar_by_index**: Query by batch molecule index → returns neighbors excluding the query molecule itself.

9. **test_nearest_neighbors**: Batch of 5 molecules → returns 5 results, each with isolation_score between 0 and 1.

10. **test_similarity_matrix_dense**: Batch of 10 molecules → representation="dense", data is upper-triangle.

11. **test_similarity_matrix_sparse**: Batch of 600 molecules (use diverse set) → representation="sparse", data contains only pairs with sim > threshold.

12. **test_similarity_matrix_refuses_large**: Batch of 2001 molecules → returns error dict.

13. **test_fingerprint_uses_morgan_generator**: Verify `rdFingerprintGenerator.GetMorganGenerator` is used (not deprecated API) — check import in source file or verify fingerprint properties.

Use a helper function `_make_batch(smiles_list)` that creates result dicts with sequential indices. For large batch tests, generate SMILES programmatically (e.g., varying chain length: "C"*n + "O" for n in range).

Mark t-SNE tests with `@pytest.mark.slow` if they take >5 seconds — they may need `openTSNE` installed.
  </action>
  <verify>
    <automated>cd /Volumes/Data_Drive/Project/2026/chemstructval/backend && /Users/kohulanrajan/anaconda3/envs/cheminformatics/bin/python -m pytest tests/test_analytics_chemspace.py -x -v -k "not slow"</automated>
  </verify>
  <done>13+ tests pass covering PCA, t-SNE (with size/perplexity guards), similarity search, nearest neighbors, and similarity matrix with dense/sparse representation switching</done>
</task>

</tasks>

<verification>
1. openTSNE is in pyproject.toml dependencies
2. Morgan fingerprints use rdFingerprintGenerator (not AllChem.GetMorganFingerprintAsBitVect)
3. PCA uses randomized SVD (no sklearn import)
4. t-SNE enforces ≤2000 limit and auto-adjusts perplexity
5. Similarity matrix switches between dense (≤500) and sparse (500-2000) representations
6. All tests pass (t-SNE tests may need openTSNE installed)
</verification>

<success_criteria>
- BATCH-09 through BATCH-12 fully implemented
- Chemical space service importable by analytics_tasks.py
- openTSNE dependency added
- All non-slow tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-batch-analytics/03-04-SUMMARY.md`
</output>
