---
phase: 05-visualizations
plan: 02
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - frontend/src/components/batch/MoleculeComparisonPanel.tsx
  - frontend/src/components/batch/MoleculePropertyRadar.tsx
  - frontend/src/components/batch/BatchTimeline.tsx
  - frontend/src/components/batch/BatchResultsTable.tsx
  - frontend/src/pages/BatchValidation.tsx
autonomous: true
requirements:
  - VIZ-07
  - VIZ-08
  - VIZ-09

must_haves:
  truths:
    - "User can select up to 2 molecules from the batch results table (checkboxes) or from chart data points, and a floating 'Compare (N)' button appears"
    - "Molecule comparison panel shows two molecules side-by-side with 2D structure rendering, properties table, and overlaid radar chart"
    - "Per-molecule property radar shows the individual molecule's properties normalized 0-1 overlaid against the dataset average from StatisticsResult"
    - "Batch timeline shows the batch processing phases (pending, processing, analytics, complete) with timing indicators"
    - "Comparison panel slides in from the right as a drawer without disrupting the main batch view"
  artifacts:
    - path: "frontend/src/components/batch/MoleculeComparisonPanel.tsx"
      provides: "VIZ-07 side-by-side molecule comparison with structure, table, radar"
      contains: "MoleculeComparisonPanel"
    - path: "frontend/src/components/batch/MoleculePropertyRadar.tsx"
      provides: "VIZ-08 per-molecule radar vs dataset average"
      contains: "MoleculePropertyRadar"
    - path: "frontend/src/components/batch/BatchTimeline.tsx"
      provides: "VIZ-09 batch processing timeline"
      contains: "BatchTimeline"
  key_links:
    - from: "frontend/src/pages/BatchValidation.tsx"
      to: "frontend/src/components/batch/MoleculeComparisonPanel.tsx"
      via: "Floating compare button + drawer render"
      pattern: "MoleculeComparisonPanel"
    - from: "frontend/src/components/batch/MoleculeComparisonPanel.tsx"
      to: "frontend/src/components/batch/MoleculePropertyRadar.tsx"
      via: "Renders radar for each selected molecule"
      pattern: "MoleculePropertyRadar"
    - from: "frontend/src/pages/BatchValidation.tsx"
      to: "frontend/src/components/batch/BatchTimeline.tsx"
      via: "Rendered in results state above or within analytics panel"
      pattern: "BatchTimeline"
---

<objective>
Build the Single Molecule Deep View: molecule comparison panel (VIZ-07), per-molecule property radar (VIZ-08), and batch timeline (VIZ-09). Integrates with the selection system from Plan 05-01 to enable compare-from-anywhere flow.

Purpose: Scientists can drill down from batch overview to individual molecule comparison — seeing two molecules side-by-side with structures, property differences, and radar overlays against dataset average — plus understanding batch processing timeline.

Output: 3 new components + modifications to BatchResultsTable and BatchValidation page for comparison flow integration.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-visualizations/05-CONTEXT.md
@.planning/phases/05-visualizations/05-RESEARCH.md
@.planning/phases/05-visualizations/05-01-SUMMARY.md
@frontend/src/types/batch.ts
@frontend/src/types/analytics.ts
@frontend/src/pages/BatchValidation.tsx
@frontend/src/components/batch/BatchResultsTable.tsx
@frontend/src/components/batch/BatchAnalyticsPanel.tsx
@frontend/src/components/scoring-profiles/BioavailabilityCard.tsx
@frontend/src/hooks/useBrushSelection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Molecule comparison panel (VIZ-07) with property radar (VIZ-08)</name>
  <files>
    frontend/src/components/batch/MoleculeComparisonPanel.tsx
    frontend/src/components/batch/MoleculePropertyRadar.tsx
  </files>
  <action>
    **1. Create `frontend/src/components/batch/MoleculePropertyRadar.tsx`** — VIZ-08 per-molecule radar vs dataset average:
    - Props: `molecule: BatchResult`, `datasetStats: PropertyStats[] | null`, `label?: string`
    - Radar properties: MW, LogP, TPSA, QED, SA Score, Fsp3 — extract from BatchResult.scoring/validation fields
    - Normalize each property to 0-1 scale using predefined min/max ranges:
      - MW: 0-800, LogP: -5 to 8, TPSA: 0-200, QED: 0-1, SA Score: 1-10, Fsp3: 0-1
    - Dataset average line: compute normalized values from PropertyStats mean values (always visible, reduced opacity — per research discretion decision)
    - Use Recharts `<RadarChart>` with `<PolarGrid>`, `<PolarAngleAxis>`, `<PolarRadiusAxis domain={[0, 1]}>`
    - Two `<Radar>` layers: "Dataset Average" (green, stroke rgba(16,185,129,0.4), fill rgba(16,185,129,0.08)) and "This Molecule" (primary, stroke rgba(196,30,58,0.9), fill rgba(196,30,58,0.2), with dots)
    - Match existing BioavailabilityCard RadarChart pattern for consistency
    - Custom tooltip showing property name, molecule value (raw), dataset mean (raw), and normalized values
    - `<ResponsiveContainer width="100%" height={280}>`
    - If datasetStats is null, render only the molecule radar (no average line)

    **2. Create `frontend/src/components/batch/MoleculeComparisonPanel.tsx`** — VIZ-07 side-by-side comparison:
    - Props: `molecules: BatchResult[]` (max 2), `datasetStats: PropertyStats[] | null`, `onClose: () => void`, `onRemoveMolecule: (index: number) => void`
    - Renders as a right-side drawer using Framer Motion AnimatePresence:
      - `fixed right-0 top-0 h-full w-[480px] max-w-[90vw] bg-[var(--color-surface-elevated)] border-l border-[var(--color-border)] shadow-2xl z-50 overflow-y-auto`
      - Slide in from right: initial={{ x: 480 }}, animate={{ x: 0 }}, exit={{ x: 480 }}
    - Header: "Compare Molecules" title + close button (X icon)
    - For each molecule (up to 2 side by side):
      - 2D structure rendering using existing `MoleculeViewer` component (import from molecules/MoleculeViewer). Width: 200px per molecule, height: 160px
      - SMILES displayed below structure (truncated with tooltip for full)
      - Remove button (X) to deselect individual molecule
    - Properties comparison table below structures:
      - Rows: MW, LogP, TPSA, QED, SA Score, Fsp3, Overall Score, Lipinski Violations
      - Columns: Property name | Molecule 1 value | Molecule 2 value (or single column if only 1 selected)
      - Highlight differences: color cells green if better, red if worse (compared between the two molecules; for Lipinski violations, fewer = better; for QED/score, higher = better)
      - If only 1 molecule selected, show single column with property values
    - Below the table: MoleculePropertyRadar for each molecule, overlaid in a single radar chart
      - When 2 molecules: render one RadarChart with 3 Radar layers — molecule A (primary), molecule B (accent #d97706), dataset average (green)
      - When 1 molecule: render single RadarChart with molecule + dataset average
    - Card styling consistent with existing app: `rounded-2xl`, theme borders, font-display for headers
    - Backdrop overlay (optional): semi-transparent dark overlay behind the drawer, clicking it closes the panel

    **Design decisions per CONTEXT.md:**
    - Strict 2-molecule limit (locked decision)
    - Shows structure + properties table + radar (locked decision)
    - Non-disruptive: chart stays visible behind drawer (locked decision)
  </action>
  <verify>
    <automated>cd /Volumes/Data_Drive/Project/2026/chemstructval/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Verify MoleculePropertyRadar renders radar with molecule + dataset average lines, MoleculeComparisonPanel shows drawer with structures, properties table, and radar.</manual>
  </verify>
  <done>
    - MoleculePropertyRadar renders 6-property radar normalized 0-1 with molecule line and dataset average line
    - MoleculeComparisonPanel renders as slide-in drawer with 2D structures via MoleculeViewer, comparison properties table with difference highlighting, and overlaid radar chart
    - Strict 2-molecule maximum enforced
    - Close button and backdrop dismiss the panel
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Batch timeline (VIZ-09) and comparison flow integration</name>
  <files>
    frontend/src/components/batch/BatchTimeline.tsx
    frontend/src/components/batch/BatchResultsTable.tsx
    frontend/src/pages/BatchValidation.tsx
  </files>
  <action>
    **1. Create `frontend/src/components/batch/BatchTimeline.tsx`** — VIZ-09 batch processing timeline:
    - Props: `statistics: BatchStatistics`, `analyticsStatus: Record<string, AnalysisStatus> | null`
    - Per research open question resolution: implement as "processing status chart" showing batch phases with approximate time bars
    - Timeline phases (horizontal or vertical):
      1. "Upload" — always complete (green checkmark)
      2. "Validation" — always complete when viewing results (green), show processing_time_seconds
      3. "Analytics" — status from analyticsStatus: pending (gray), computing (amber pulse), complete (green), failed (red)
      4. "Complete" — overall status indicator
    - Visual: horizontal timeline with connected nodes (circles) and status-colored segments between them
    - Each node: 32px circle with icon (Upload, Shield, BarChart3, CheckCircle from lucide-react), status color fill, label below
    - Connecting segments: 4px height bars between circles, colored by completion status
    - Below the timeline: summary stats in small text — "N molecules validated in Xs", "N scaffolds identified", "N outliers detected"
    - Use Framer Motion for staggered node entrance animation (staggerChildren: 0.1)
    - If analyticsStatus is null, show phases 1-2 as complete, phase 3-4 as pending
    - Responsive: horizontal on lg screens, vertical on mobile (flex-col)

    **2. Modify `frontend/src/components/batch/BatchResultsTable.tsx`** — Add compare flow integration:
    - Add a "Compare" column header or integrate with existing selection checkboxes
    - When user has 1-2 molecules selected via existing `selectedIndices` prop, show a floating "Compare (N)" button at the bottom of the table
    - The floating button: `fixed bottom-6 left-1/2 -translate-x-1/2 z-40` with primary background, Framer Motion scale-in animation when selection count is 1 or 2
    - If selection count > 2, show "Select up to 2 to compare" tooltip on the button (button disabled)
    - Button click triggers `onCompare` callback (new prop)
    - Add `onCompare?: () => void` prop to BatchResultsTable interface
    - Do NOT break existing table rendering, filtering, sorting, or pagination — only add the floating button

    **3. Modify `frontend/src/pages/BatchValidation.tsx`** — Wire comparison flow and timeline:
    - Add `compareMode` state: `useState<boolean>(false)`
    - Add `compareMolecules` derived state: filter `resultsData.results` by indices in `selectedIndices`, take first 2
    - Add `handleCompare` callback: sets `compareMode(true)` — triggered by floating button in BatchResultsTable
    - Add `handleCloseCompare` callback: sets `compareMode(false)`
    - Add `handleRemoveFromCompare` callback: dispatches TOGGLE action to remove molecule from selection, if selection becomes empty set compareMode(false)
    - Render `MoleculeComparisonPanel` conditionally when `compareMode && compareMolecules.length > 0`:
      - Pass `molecules={compareMolecules}`, `datasetStats` from analytics statistics property_stats, `onClose={handleCloseCompare}`, `onRemoveMolecule={handleRemoveFromCompare}`
    - Render `BatchTimeline` above or within the analytics panel section:
      - Pass `statistics={resultsData.statistics}`, `analyticsStatus` from useBatchAnalytics response status field
      - Place it as the first item in the analytics section, before the tabbed chart panel
    - Pass `onCompare={handleCompare}` to BatchResultsTable
    - Wire chart click-to-compare: when a chart point is clicked and selectedIndices has 1-2 items, user can click the floating Compare button to enter compare mode

    **Integration notes:**
    - MoleculeComparisonPanel renders as a fixed drawer — does not affect page layout flow
    - BatchTimeline is a lightweight summary component — renders above the chart tabs
    - Existing batch results table, filtering, and export functionality must remain fully functional
    - The floating Compare button only appears when selection count is 1 or 2, disappears otherwise
  </action>
  <verify>
    <automated>cd /Volumes/Data_Drive/Project/2026/chemstructval/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Verify BatchTimeline renders processing phases, BatchResultsTable shows floating Compare button when 1-2 selected, Compare button opens MoleculeComparisonPanel drawer with structures, table, and radar.</manual>
  </verify>
  <done>
    - BatchTimeline renders 4-phase horizontal timeline with status-colored nodes and timing info
    - BatchResultsTable shows floating "Compare (N)" button when 1-2 molecules are selected
    - MoleculeComparisonPanel opens as a slide-in drawer from the right
    - Comparison shows 2D structures, properties table with difference coloring, and overlaid radar
    - Per-molecule radar shows molecule vs dataset average
    - Closing the panel preserves selection state
    - Existing batch page functionality (table, filters, export) unaffected
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — no TypeScript compilation errors
2. `cd frontend && npm run dev` — app starts, navigate to batch results page
3. Visual checks:
   - BatchTimeline renders above analytics charts with correct phase statuses
   - Select 2 molecules from table → floating "Compare (2)" button appears
   - Click Compare → drawer slides in with structures, properties, and radar
   - Radar shows molecule lines + dataset average
   - Close drawer → selection preserved
   - Select 3+ molecules → Compare button disabled with tooltip
4. Responsive: timeline switches to vertical on mobile, drawer uses max-w-[90vw]
</verification>

<success_criteria>
- Molecule comparison drawer renders 2 molecules side-by-side with structures, properties, and radar
- Property radar accurately normalizes molecule values and shows dataset average
- Batch timeline accurately reflects processing status
- Compare flow works from both table checkboxes and chart selections
- Strict 2-molecule limit enforced with clear user feedback
- No disruption to existing batch results page functionality
- No new npm packages added
</success_criteria>

<output>
After completion, create `.planning/phases/05-visualizations/05-02-SUMMARY.md`
</output>
