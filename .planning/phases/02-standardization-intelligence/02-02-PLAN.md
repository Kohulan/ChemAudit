---
phase: 02-standardization-intelligence
plan: "02"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/app/services/standardization/provenance.py
  - backend/app/services/standardization/stereo_tracker.py
  - backend/app/schemas/standardization.py
  - backend/tests/test_standardization/test_provenance_m22.py
  - frontend/src/types/standardization.ts
  - frontend/src/components/standardization/ProvenanceTimeline.tsx
  - frontend/src/components/standardization/ProvenanceStageCard.tsx
  - frontend/src/components/standardization/StandardizationResults.tsx
  - frontend/src/components/standardization/index.ts
autonomous: true
requirements:
  - STD-05
  - STD-06

must_haves:
  truths:
    - "Kekulization/aromaticity changes during standardization are reported as ring-level changes with ring_atoms, ring_size, before_type, and after_type (STD-05)"
    - "Stereochemistry normalization tracking reports per-center detail: atom_idx, type, before_config, after_config, reason (STD-06)"
    - "Stereo provenance includes both summary (stereo_stripped, centers_lost, bonds_lost) and per_center breakdown (STD-06)"
    - "DVAL cross-references are included in stereo provenance when applicable (e.g., 'DVAL-01 found N undefined centers')"
    - "Frontend displays provenance as a vertical timeline with expandable stage cards when provenance data is present"
    - "Frontend falls back to existing StepsList when provenance is null"
    - "Stage cards show before/after SMILES, status icons, and expandable detail sections with atom-level changes"
    - "Molecule structures are rendered on-demand via 'Show structure' button (not eagerly loaded)"
  artifacts:
    - path: "backend/app/services/standardization/provenance.py"
      provides: "Extended with ring aromaticity tracking and stereo center detail"
      contains: "_capture_ring_aromaticity_changes"
    - path: "backend/app/services/standardization/stereo_tracker.py"
      provides: "Extended StereoComparison with per_center_detail"
      contains: "StereoCenterDetail"
    - path: "backend/tests/test_standardization/test_provenance_m22.py"
      provides: "Tests for STD-05 and STD-06"
      min_lines: 80
    - path: "frontend/src/components/standardization/ProvenanceTimeline.tsx"
      provides: "Vertical timeline rendering provenance stages"
      min_lines: 40
    - path: "frontend/src/components/standardization/ProvenanceStageCard.tsx"
      provides: "Expandable stage card with before/after SMILES and detail sections"
      min_lines: 80
    - path: "frontend/src/types/standardization.ts"
      provides: "TypeScript interfaces for all provenance types"
      contains: "StandardizationProvenance"
  key_links:
    - from: "frontend/src/components/standardization/StandardizationResults.tsx"
      to: "frontend/src/components/standardization/ProvenanceTimeline.tsx"
      via: "Conditional render: provenance ? ProvenanceTimeline : StepsList"
      pattern: "result\\.provenance.*ProvenanceTimeline"
    - from: "frontend/src/components/standardization/ProvenanceStageCard.tsx"
      to: "frontend/src/components/molecules/MoleculeViewer.tsx"
      via: "On-demand structure rendering with highlightAtoms"
      pattern: "MoleculeViewer.*highlightAtoms"
    - from: "backend/app/services/standardization/provenance.py"
      to: "backend/app/services/standardization/stereo_tracker.py"
      via: "StereoCenterDetail for per-center stereo breakdown"
      pattern: "StereoCenterDetail"
---

<objective>
Implement ring/aromaticity normalization tracking (STD-05), stereochemistry normalization tracking (STD-06), and the full frontend provenance timeline UI.

Purpose: Completes the Standardization Intelligence feature set — users see ring-level aromaticity changes and per-center stereo normalization detail in the provenance record, AND the frontend renders a vertical timeline with expandable stage cards, on-demand structure rendering, and color-coded atom highlighting for all provenance data from Plan 02-01.

Output: Extended provenance backend (ring + stereo tracking), extended stereo_tracker, frontend ProvenanceTimeline and ProvenanceStageCard components, TypeScript type extensions, M2.2 tests.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-standardization-intelligence/02-RESEARCH.md
@.planning/phases/02-standardization-intelligence/02-01-SUMMARY.md
@backend/app/services/standardization/provenance.py
@backend/app/services/standardization/stereo_tracker.py
@backend/app/schemas/standardization.py
@frontend/src/types/standardization.ts
@frontend/src/components/standardization/StandardizationResults.tsx
@frontend/src/components/standardization/StepsList.tsx
@frontend/src/components/validation/DeepValidationTab.tsx
@frontend/src/components/molecules/MoleculeViewer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Ring aromaticity tracking (STD-05), stereo center detail (STD-06), and tests</name>
  <files>
    backend/app/services/standardization/provenance.py
    backend/app/services/standardization/stereo_tracker.py
    backend/app/schemas/standardization.py
    backend/tests/test_standardization/test_provenance_m22.py
  </files>
  <action>
**1. Add ring aromaticity tracking to `provenance.py` (STD-05):**

Add method `_capture_ring_aromaticity_changes(before_mol, after_mol) -> List[RingChange]`:
- Call `mol.GetRingInfo().AtomRings()` on both before and after molecules to get ring membership
- For each ring, check `atom.GetIsAromatic()` for all ring atoms
- A ring is "aromatic" if ALL atoms are aromatic, "kekulized" otherwise
- Compare before/after ring aromaticity. Report changes as `RingChange` records: `{ring_atoms: List[int], ring_size: int, before_type: str, after_type: str}`
- Only valid when atom count is preserved (same guard as charge tracking)
- Integrate into `_capture_standardizer_provenance()` — add `ring_changes` to the standardizer stage's `ProvStageRecord`

Add `RingChange` to `backend/app/schemas/standardization.py`:
- `RingChange(BaseModel)`: ring_atoms: List[int], ring_size: int, before_type: str, after_type: str
- Add `ring_changes: List[RingChange] = []` field to `ProvStageRecord`

**2. Add per-center stereo detail to `stereo_tracker.py` (STD-06):**

Add `StereoCenterDetail` dataclass:
```python
@dataclass
class StereoCenterDetail:
    atom_idx: int
    type: str          # "tetrahedral" or "double_bond"
    before_config: str  # "R", "S", "?", "absent", "E", "Z"
    after_config: str
    reason: str        # "standardization", "tautomer_canonicalization", "get_parent"
```

Extend `StereoComparison` dataclass with: `per_center_detail: List[StereoCenterDetail] = field(default_factory=list)`

Update `StereoTracker.compare()` to populate `per_center_detail`:
- Build `before_map = {idx: label for idx, label in stereo_before.chiral_centers}`
- Build `after_map = {idx: label for idx, label in stereo_after.chiral_centers}`
- For each idx in `set(before_map) | set(after_map)`, if config differs, add a `StereoCenterDetail`
- Also handle double bond stereo: build maps from `double_bond_stereo`, compare before/after
- Accept optional `reason` parameter (default "standardization") so the provenance pipeline can pass stage-specific reasons

**3. Integrate into provenance pipeline:**

Update `ProvenancePipeline.standardize_with_provenance()`:
- After tautomer stage (if run), capture per-center stereo detail by calling `StereoTracker.compare(stereo_before, stereo_after)` with the extended comparison
- Build `StereoProvenance` with `stereo_stripped`, `centers_lost`, `bonds_lost`, and `per_center` list from `StereoComparison.per_center_detail`
- Set `provenance.stereo_summary` with this data
- For DVAL cross-reference (STD-06): if `dval_results` is passed in options (optional, for future frontend integration), annotate `dval_cross_refs` on the relevant stage. For now, leave as empty list with a TODO comment noting that cross-refs require the frontend to pass prior DVAL results. Do NOT block on this — it's documented as optional in the research open questions.

**4. Update `StereoProvenance` in schemas:**

Update the `StereoProvenance` model in `standardization.py` (created in Plan 01 as placeholder):
- `per_center: List[StereoCenterDetailSchema] = []` where `StereoCenterDetailSchema(BaseModel)` mirrors the dataclass: atom_idx, type, before_config, after_config, reason

**5. Create `backend/tests/test_standardization/test_provenance_m22.py` (~10 tests):**

**TestRingAromaticityTracking (~4 tests):**
- `test_no_ring_changes_simple_molecule`: Standardize benzene, verify ring_changes is empty (no change)
- `test_ring_aromaticity_detected`: If standardize_mol() changes ring aromaticity on a test molecule, verify ring_changes has entries. If no real molecule changes aromaticity, test the helper function `_capture_ring_aromaticity_changes()` directly with a mock pair.
- `test_ring_change_fields`: Verify RingChange has ring_atoms (list of int), ring_size, before_type, after_type
- `test_ring_changes_atom_count_mismatch`: When atom count changes (fragment removal stage), ring_changes should be empty (guard works)

**TestStereoNormalizationTracking (~4 tests):**
- `test_stereo_center_detail_populated`: Standardize a molecule with stereo that gets modified (e.g., tautomer canonicalization of a chiral molecule), verify per_center_detail has entries
- `test_stereo_center_detail_fields`: Verify StereoCenterDetail has atom_idx, type, before_config, after_config, reason
- `test_stereo_summary_fields`: Verify StereoProvenance has stereo_stripped (bool), centers_lost (int), bonds_lost (int), per_center (list)
- `test_no_stereo_change`: Standardize a molecule without stereo issues, verify per_center_detail is empty and centers_lost=0

**TestStereoTrackerExtended (~2 tests):**
- `test_compare_with_per_center_detail`: Create before/after StereoInfo with different chiral_centers, verify compare() populates per_center_detail
- `test_compare_double_bond_stereo_detail`: Create before/after with different double bond stereo, verify per_center_detail includes double_bond type entries
  </action>
  <verify>
    <automated>cd /Volumes/Data_Drive/Project/2026/chemstructval/backend && /Users/kohulanrajan/anaconda3/envs/cheminformatics/bin/python -m pytest tests/test_standardization/test_provenance_m22.py -v --tb=short 2>&1 | tail -20</automated>
    <manual>All M2.2 tests pass. Existing provenance tests from Plan 01 still pass.</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>Ring aromaticity changes tracked per-ring in standardizer provenance (STD-05). Stereo normalization tracked per-center with atom_idx, type, before_config, after_config, reason (STD-06). StereoComparison extended with per_center_detail. All ~10 M2.2 tests pass. All existing tests unbroken.</done>
</task>

<task type="auto">
  <name>Task 2: Frontend provenance timeline UI and type extensions</name>
  <files>
    frontend/src/types/standardization.ts
    frontend/src/components/standardization/ProvenanceTimeline.tsx
    frontend/src/components/standardization/ProvenanceStageCard.tsx
    frontend/src/components/standardization/StandardizationResults.tsx
    frontend/src/components/standardization/index.ts
  </files>
  <action>
**1. Extend `frontend/src/types/standardization.ts`:**

Add TypeScript interfaces matching the backend Pydantic models (use separate typed fields, NOT generic `any[]`):

```typescript
export interface ChargeChange {
  atom_idx: number;
  element: string;
  before_charge: number;
  after_charge: number;
  rule_name: string;
  smarts: string;
}

export interface BondChange {
  bond_idx: number;
  atom1_idx: number;
  atom2_idx: number;
  before_type: string;
  after_type: string;
  rule_name: string;
}

export interface RadicalChange {
  atom_idx: number;
  element: string;
  before_radicals: number;
  after_radicals: number;
}

export interface RingChange {
  ring_atoms: number[];
  ring_size: number;
  before_type: string;
  after_type: string;
}

export interface FragmentRemoval {
  smiles: string;
  name: string | null;
  role: 'salt' | 'solvent' | 'counterion' | 'unknown';
  mw: number;
}

export interface TautomerProvenance {
  input_smiles: string;
  canonical_smiles: string;
  num_tautomers_enumerated: number;
  modified_atoms: number[];
  modified_bonds: number[];
  stereo_stripped: boolean;
  complexity_flag: boolean;
}

export interface StereoCenterDetail {
  atom_idx: number;
  type: string;
  before_config: string;
  after_config: string;
  reason: string;
}

export interface StereoProvenance {
  stereo_stripped: boolean;
  centers_lost: number;
  bonds_lost: number;
  per_center: StereoCenterDetail[];
}

export interface ProvStageRecord {
  stage_name: string;
  input_smiles: string;
  output_smiles: string;
  applied: boolean;
  charge_changes: ChargeChange[];
  bond_changes: BondChange[];
  radical_changes: RadicalChange[];
  ring_changes: RingChange[];
  fragment_removals: FragmentRemoval[];
  dval_cross_refs: string[];
}

export interface StandardizationProvenance {
  stages: ProvStageRecord[];
  tautomer: TautomerProvenance | null;
  stereo_summary: StereoProvenance | null;
}
```

Add `include_provenance?: boolean` to `StandardizationOptions`.
Add `provenance?: StandardizationProvenance | null` to `StandardizationResult`.

**2. Create `frontend/src/components/standardization/ProvenanceTimeline.tsx`:**

Vertical timeline component that renders provenance stages. Design per user decisions:
- Vertical timeline with expandable stages
- Each stage shows: status icon (checkmark if applied + changes, dash if applied + no changes, X if not applied), stage name (formatted: "Checker", "Standardizer", "Parent Extraction", "Tautomer Canonicalization"), before→after SMILES (monospace), and an expandable "Details" section
- Use Framer Motion `AnimatePresence` for expand/collapse (mirror pattern from `DeepValidationTab.tsx`)
- Stage order follows pipeline flow
- If `provenance.tautomer` exists, show tautomer summary (num_tautomers_enumerated, modified_atoms count, stereo_stripped badge)
- If `provenance.stereo_summary` exists and has changes, show stereo warning banner (similar to existing stereo warning in StandardizationResults)
- Use lucide-react icons: `CheckCircle2`, `MinusCircle`, `XCircle`, `ChevronDown`, `ChevronRight`
- Tailwind styling consistent with existing standardization components

Props: `{ provenance: StandardizationProvenance }`

**3. Create `frontend/src/components/standardization/ProvenanceStageCard.tsx`:**

Individual stage card with expandable detail sections. Design per user decisions:
- Header: status icon + stage name + badge showing change count (e.g., "3 changes") + expand/collapse chevron
- Collapsed: shows before→after SMILES if different (one-liner diff with monospace font, gray background)
- Expanded detail sections (conditionally rendered based on stage data):
  - **Charge changes**: Table with columns: Atom (idx), Element, Before, After, Rule. Atom indices rendered as clickable badges (blue for charge changes — per color coding decision)
  - **Bond changes**: Table with columns: Bond, Atoms, Before, After, Rule
  - **Ring changes**: Table with columns: Ring Size, Atoms, Before Type, After Type
  - **Radical changes**: Table with columns: Atom, Element, Before, After
  - **Fragment removals**: Table with columns: Fragment (SMILES monospace), Name, Role (colored badge: salt=blue, solvent=yellow, counterion=purple, unknown=gray), MW
  - **DVAL cross-refs**: List of cross-reference strings (if any)
- "Show structure" button for on-demand molecule rendering (NOT loaded by default). When clicked, render `MoleculeViewer` with `highlightAtoms` set to affected atom indices from charge_changes/bond_changes/ring_changes. Color coding: red for removed atoms (fragment removals are shown as SMILES, not highlighted), blue for charge changes, green for bond/ring changes.
- Use Framer Motion for expand/collapse animation
- Use Tailwind for all styling, consistent with existing component patterns

Props: `{ stage: ProvStageRecord, isExpanded: boolean, onToggle: () => void }`

**4. Modify `frontend/src/components/standardization/StandardizationResults.tsx`:**

Add conditional rendering: when `result.provenance` is present (not null/undefined), render `ProvenanceTimeline` instead of `StepsList` in the "Standardization Pipeline" section.

```tsx
{/* Pipeline Steps / Provenance Timeline */}
<div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
  <h4 className="font-semibold text-gray-900 mb-4">
    Standardization Pipeline
  </h4>
  {result.provenance ? (
    <ProvenanceTimeline provenance={result.provenance} />
  ) : (
    <StepsList
      steps={result.steps_applied}
      checkerIssues={result.checker_issues}
      excludedFragments={result.excluded_fragments}
    />
  )}
</div>
```

Import `ProvenanceTimeline` at the top. Keep `StepsList` import — it's still used when provenance is null.

**5. Update `frontend/src/components/standardization/index.ts`:**

Add exports for `ProvenanceTimeline` and `ProvenanceStageCard`.
  </action>
  <verify>
    <automated>cd /Volumes/Data_Drive/Project/2026/chemstructval/frontend && npx tsc --noEmit 2>&1 | tail -20</automated>
    <manual>TypeScript compiles without errors. ProvenanceTimeline renders when provenance data is present. StepsList still renders when provenance is null. Expand/collapse works on stage cards. "Show structure" button triggers MoleculeViewer with atom highlighting.</manual>
  </verify>
  <done>Frontend ProvenanceTimeline replaces StepsList when provenance is present. ProvenanceStageCard shows expandable detail sections with typed change tables (charge, bond, ring, radical, fragment). On-demand structure rendering with color-coded atom highlighting. TypeScript types match all backend provenance models. StepsList still used as fallback when provenance is null. TypeScript compiles without errors.</done>
</task>

</tasks>

<verification>
1. `pytest tests/test_standardization/test_provenance_m22.py -v` — all M2.2 tests pass
2. `pytest tests/test_standardization/ -v` — all standardization tests pass (including Plan 01 provenance tests)
3. `cd frontend && npx tsc --noEmit` — TypeScript compiles without errors
4. Frontend renders ProvenanceTimeline when provenance data present in API response
5. Frontend renders StepsList when provenance is null (backward compatible)
6. Stereo provenance includes per_center_detail with atom_idx, type, before_config, after_config, reason
7. Ring changes tracked per-ring with ring_atoms, ring_size, before_type, after_type
</verification>

<success_criteria>
- Ring aromaticity changes reported at ring level with atom indices (STD-05)
- Stereo normalization tracked per-center with full detail (STD-06)
- DVAL cross-reference infrastructure in place (empty by default, populated when DVAL results available)
- ProvenanceTimeline renders vertical timeline with expandable stage cards
- On-demand structure rendering with color-coded atom highlighting
- Existing StepsList still works as fallback
- All backend tests pass, TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/02-standardization-intelligence/02-02-SUMMARY.md`
</output>
