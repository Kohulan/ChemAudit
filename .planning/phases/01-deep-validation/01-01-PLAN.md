---
phase: 01-deep-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/services/validation/checks/deep_stereo_tautomer.py
  - backend/app/services/validation/checks/__init__.py
  - backend/app/services/validation/engine.py
  - backend/app/core/cache.py
  - backend/tests/test_validation/test_deep_stereo_tautomer_checks.py
autonomous: true
requirements:
  - DVAL-01
  - DVAL-02
  - DVAL-03
  - DVAL-04
  - DVAL-05

must_haves:
  truths:
    - "A molecule with undefined stereocenters returns a check result listing each undefined center's atom index and all enumerated stereoisomer SMILES (up to 128 cap)"
    - "A molecule with tautomeric forms returns the canonical tautomer SMILES, a count of enumerable tautomers, and a flag indicating whether the input is the canonical form"
    - "A molecule with aromatic system issues (unusual ring sizes, charged aromatics) returns a structured warning with affected atom indices"
    - "A molecule with 3D coordinates is identified as 3D; one with 2D coordinates as 2D; one with no conformer as 'no_coordinates'"
    - "Validation cache keys include a CHECKS_VERSION prefix so adding new checks invalidates stale cached results"
  artifacts:
    - path: "backend/app/services/validation/checks/deep_stereo_tautomer.py"
      provides: "5 deep validation checks: stereoisomer_enumeration, tautomer_detection, aromatic_system_validation, coordinate_dimension"
      contains: "@CheckRegistry.register"
    - path: "backend/tests/test_validation/test_deep_stereo_tautomer_checks.py"
      provides: "Tests for DVAL-01..05 checks"
      contains: "class TestStereoisomerEnumeration"
    - path: "backend/app/core/cache.py"
      provides: "CHECKS_VERSION constant in cache key"
      contains: "CHECKS_VERSION"
  key_links:
    - from: "backend/app/services/validation/checks/deep_stereo_tautomer.py"
      to: "backend/app/services/validation/registry.py"
      via: "@CheckRegistry.register() decorator"
      pattern: "@CheckRegistry\\.register"
    - from: "backend/app/services/validation/engine.py"
      to: "backend/app/services/validation/checks/deep_stereo_tautomer.py"
      via: "import to trigger registration"
      pattern: "import app\\.services\\.validation\\.checks\\.deep_stereo_tautomer"
    - from: "backend/app/core/cache.py"
      to: "validation cache keys"
      via: "CHECKS_VERSION prefix in key format"
      pattern: "CHECKS_VERSION.*validation:"
---

<objective>
Implement the 5 Milestone 1.1 deep validation checks (DVAL-01 through DVAL-05) covering stereo completeness, tautomer detection, aromatic system validation, and coordinate dimension detection. Also add CHECKS_VERSION to cache keys to prevent stale cached results after adding new checks.

Purpose: These checks give users detailed stereo and tautomer information that the existing v1 checks only partially cover (v1 detects undefined stereocenters but does not enumerate stereoisomers or detect tautomers at all).

Output: 5 new registered checks in `deep_stereo_tautomer.py`, corresponding tests, and cache key versioning.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-deep-validation/01-CONTEXT.md
@.planning/phases/01-deep-validation/01-RESEARCH.md
@backend/app/services/validation/checks/base.py
@backend/app/services/validation/checks/basic.py
@backend/app/services/validation/checks/stereo.py
@backend/app/services/validation/checks/__init__.py
@backend/app/services/validation/engine.py
@backend/app/services/validation/registry.py
@backend/app/core/cache.py
@backend/app/schemas/common.py
@backend/tests/test_validation/test_stereo_checks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement 5 stereo/tautomer checks + cache key versioning</name>
  <files>
    backend/app/services/validation/checks/deep_stereo_tautomer.py
    backend/app/services/validation/checks/__init__.py
    backend/app/services/validation/engine.py
    backend/app/core/cache.py
  </files>
  <action>
Create `backend/app/services/validation/checks/deep_stereo_tautomer.py` with 4 check classes (DVAL-01 and DVAL-02 are combined into one check since DVAL-02 is the enumeration output of DVAL-01):

1. **StereoisomerEnumerationCheck** (`stereoisomer_enumeration`, category=`stereo_tautomer`):
   - Covers DVAL-01 + DVAL-02 (detection + enumeration are one operation)
   - Use `FindMolChiralCenters(mol, includeUnassigned=True)` to find undefined centers
   - Use `EnumerateStereoisomers(mol, StereoEnumerationOptions(unique=True))` to enumerate
   - ENUMERATION_CAP = 128 (per Claude's Discretion: 2^7)
   - If cap exceeded: return count only, set `cap_exceeded: true` in details
   - Return `details`: `{undefined_count, total_centers, atom_indices, stereoisomer_smiles, enumeration_cap, cap_exceeded}`
   - `affected_atoms`: list of atom indices with undefined stereo
   - Default severity: WARNING (undefined stereo is not always an error)
   - Guard against None mol; guard against multi-fragment molecules (use largest fragment)
   - Human-readable message: "Found {n} undefined stereocenter(s) at atom indices {indices}. {count} stereoisomers enumerated."

2. **TautomerDetectionCheck** (`tautomer_detection`, category=`stereo_tautomer`):
   - Covers DVAL-03
   - Use `rdMolStandardize.TautomerEnumerator()` — NOT MolVS tautomer module
   - CRITICAL: Use `enumerator.Canonicalize(mol)` — NOT `GetCanonicalTautomer` (does not exist)
   - Default max tautomers: 1000 (RDKit default). For single-molecule validation this is fine; production cap is configurable server-side
   - Enumerate tautomers, get canonical form, compare canonical SMILES to input SMILES
   - Return `details`: `{tautomer_count, canonical_smiles, is_canonical_form, tautomer_smiles (list, up to cap)}`
   - For multi-fragment molecules: run on largest fragment only (per Research pitfall #4)
   - Default severity: INFO (having tautomers is informational, not an issue)
   - Human-readable message: "Molecule has {n} tautomeric forms. {Is/Is not} the canonical tautomer."

3. **AromaticSystemValidationCheck** (`aromatic_system_validation`, category=`stereo_tautomer`):
   - Covers DVAL-04
   - Check 1: Unusual aromatic ring sizes (not 5 or 6 membered) — use `RingInfo.AtomRings()` and check if ring atoms are all aromatic
   - Check 2: Charged aromatics — iterate aromatic atoms, check `GetFormalCharge() != 0`
   - Note: Kekulization failures are already caught by the existing `AromaticityCheck` in basic.py. This check extends with ring-size and charge analysis only.
   - Return `details`: `{unusual_ring_sizes: [{ring_size, atom_indices}], charged_aromatics: [{atom_idx, symbol, charge}]}`
   - `affected_atoms`: union of all flagged atom indices
   - Default severity: WARNING
   - Human-readable message describing unusual rings and charged aromatics found

4. **CoordinateDimensionCheck** (`coordinate_dimension`, category=`stereo_tautomer`):
   - Covers DVAL-05
   - Check `mol.GetNumConformers()` — if 0, dimension = "no_coordinates"
   - If conformer exists: check `conf.GetAtomPosition(i).z` for all atoms
   - All z == 0.0 → "2d"; any non-zero z → "3d"
   - Check for degenerate coordinates: all atoms at same position → "degenerate"
   - Return `details`: `{dimension: "2d"|"3d"|"no_coordinates"|"degenerate", num_conformers}`
   - Default severity: INFO (purely informational)
   - Always passes (informational check)

All checks must:
- Inherit from `BaseCheck` using `from .base import BaseCheck, CheckResult`
- Import `from ..registry import CheckRegistry` and `from app.schemas.common import Severity`
- Use `@CheckRegistry.register("check_name")` decorator
- Set `name`, `description`, `category` class attributes
- Include None mol guard returning ERROR
- Include try/except returning ERROR on unexpected failure
- Include `affected_atoms` (empty list if not applicable) and `details` (dict) in every CheckResult
- Include human-readable `message` string (1-2 sentences)

**Engine import:** Add `import app.services.validation.checks.deep_stereo_tautomer  # noqa: F401` in `engine.py` after the existing check imports.

**__init__.py update:** Add imports for the 4 new check classes and add them to `__all__`.

**Cache key versioning (STATE.md mandate):**
In `backend/app/core/cache.py`:
- Add `CHECKS_VERSION = "v2"` constant near the top (after imports)
- Update `validation_cache_key()` return format from `f"validation:{inchikey}:{checks_hash}"` to `f"validation:{CHECKS_VERSION}:{inchikey}:{checks_hash}"`
- Update the docstring example to reflect the new format
- Update the `invalidate_cached_validation()` scan pattern from `f"validation:{inchikey}:*"` to `f"validation:*:{inchikey}:*"`
  </action>
  <verify>
    <automated>cd /Volumes/Data_Drive/Project/2026/chemstructval/backend && python -c "
from app.services.validation.registry import CheckRegistry
import app.services.validation.checks.deep_stereo_tautomer
names = CheckRegistry.list_names() if hasattr(CheckRegistry, 'list_names') else list(CheckRegistry.get_all().keys())
expected = {'stereoisomer_enumeration', 'tautomer_detection', 'aromatic_system_validation', 'coordinate_dimension'}
missing = expected - set(names)
assert not missing, f'Missing checks: {missing}'
print(f'All 4 M1.1 checks registered: {expected}')
# Verify cache versioning
from app.core.cache import validation_cache_key, CHECKS_VERSION
assert CHECKS_VERSION == 'v2', f'CHECKS_VERSION should be v2, got {CHECKS_VERSION}'
key = validation_cache_key('BSYNRYMUTXBXSQ-UHFFFAOYSA-N', None)
assert ':v2:' in key, f'Cache key missing version: {key}'
print(f'Cache key versioning OK: {key}')
"</automated>
    <manual>Verify the 4 new checks appear in CheckRegistry alongside the 11 existing checks (15 total)</manual>
  </verify>
  <done>4 check classes registered (stereoisomer_enumeration, tautomer_detection, aromatic_system_validation, coordinate_dimension), engine imports them, cache keys include CHECKS_VERSION=v2</done>
</task>

<task type="auto">
  <name>Task 2: Write comprehensive tests for M1.1 checks</name>
  <files>
    backend/tests/test_validation/test_deep_stereo_tautomer_checks.py
  </files>
  <action>
Create `backend/tests/test_validation/test_deep_stereo_tautomer_checks.py` following the exact pattern of `test_stereo_checks.py` (class-per-check, test-per-behavior, TestRegistration class at end).

**TestStereoisomerEnumeration class:**
- `test_no_stereocenters_passes`: Simple molecule like ethanol (`CCO`) — should pass, undefined_count=0
- `test_undefined_stereocenters_detected`: Use `CC(O)C(N)CC` (2 undefined centers) — should fail, return atom indices and enumerated SMILES
- `test_fully_defined_stereo_passes`: Use `C[C@H](O)[C@@H](N)CC` — should pass, stereoisomer_smiles contains the input itself
- `test_cap_exceeded`: Use a molecule with many stereocenters (e.g., sugars with >7 undefined centers) — cap_exceeded=true, stereoisomer_smiles should be empty
- `test_none_molecule_returns_error`: Pass None, expect ERROR severity
- `test_details_structure`: Verify details dict contains all required keys: undefined_count, total_centers, atom_indices, stereoisomer_smiles, enumeration_cap, cap_exceeded

**TestTautomerDetection class:**
- `test_molecule_with_tautomers`: Use phenol/keto form like `OC1=CC=CC=C1` (phenol) — should detect tautomers
- `test_molecule_without_tautomers`: Use `CC` (ethane) — tautomer_count should be 1 (just itself)
- `test_canonical_form_detection`: Verify is_canonical_form flag is correctly set
- `test_none_molecule_returns_error`: Pass None, expect ERROR
- `test_details_structure`: Verify details dict contains tautomer_count, canonical_smiles, is_canonical_form, tautomer_smiles

**TestAromaticSystemValidation class:**
- `test_normal_benzene_passes`: Use `c1ccccc1` — no unusual rings, no charged aromatics
- `test_charged_aromatic_detected`: Use pyridinium `[nH+]1ccccc1` or similar — should flag charged aromatic
- `test_none_molecule_returns_error`: Pass None, expect ERROR
- `test_affected_atoms_populated`: Verify affected_atoms list contains correct atom indices

**TestCoordinateDimension class:**
- `test_no_conformer`: Parse from SMILES (no conformer) — dimension="no_coordinates"
- `test_2d_coordinates`: Create mol from SMILES, add 2D conformer with `AllChem.Compute2DCoords` — dimension="2d"
- `test_3d_coordinates`: Create mol, embed with `AllChem.EmbedMolecule` — dimension="3d"
- `test_none_molecule_returns_error`: Pass None, expect ERROR

**TestRegistration class:**
- `test_all_m11_checks_registered`: Verify all 4 check names appear in `CheckRegistry.get_all()`

Use `from rdkit import Chem` and `from rdkit.Chem import AllChem` for creating test molecules. Do NOT mock RDKit — test with real molecules for accuracy (per TESTING.md: "What NOT to Mock: Business logic functions — test with real RDKit/MolVS for accuracy").
  </action>
  <verify>
    <automated>cd /Volumes/Data_Drive/Project/2026/chemstructval/backend && pytest tests/test_validation/test_deep_stereo_tautomer_checks.py -x -q</automated>
  </verify>
  <done>All tests pass for the 4 M1.1 checks covering stereo enumeration, tautomer detection, aromatic system validation, and coordinate dimension</done>
</task>

</tasks>

<verification>
1. `cd backend && python -c "from app.services.validation.engine import validation_engine; checks = validation_engine.list_checks(); print(checks)"` shows `stereo_tautomer` category containing the 4 new check names
2. `cd backend && pytest tests/test_validation/test_deep_stereo_tautomer_checks.py -v` all tests pass
3. `cd backend && python -c "from app.core.cache import validation_cache_key; k = validation_cache_key('TEST', None); assert ':v2:' in k; print('OK:', k)"` confirms cache versioning
4. Existing tests still pass: `cd backend && pytest tests/test_validation/ -x -q`
</verification>

<success_criteria>
- 4 new check classes registered and discoverable by ValidationEngine
- Each check returns CheckResult with affected_atoms, details, and human-readable message
- Stereoisomer enumeration caps at 128 and returns count-only above cap
- Tautomer detection uses Canonicalize (not GetCanonicalTautomer)
- Cache keys contain CHECKS_VERSION=v2
- All new tests pass; existing tests unbroken
</success_criteria>

<output>
After completion, create `.planning/phases/01-deep-validation/01-01-SUMMARY.md`
</output>
